<!DOCTYPE html>
<html>
<head>
    <title>CCABN WiFi Setup</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            margin: 0;
            padding: 20px;
            background: #0d1117;
            color: #e6edf3;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            max-width: 400px;
            width: 100%;
            background: #161b22;
            padding: 32px;
            border-radius: 12px;
            border: 1px solid #30363d;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
        }

        .logo {
            text-align: center;
            margin-bottom: 24px;
        }

        .logo img {
            max-width: 80px;
            height: auto;
        }

        h1 {
            color: #f0f6fc;
            text-align: center;
            margin: 0 0 32px 0;
            font-size: 24px;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #f0f6fc;
        }

        button {
            width: 100%;
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .refresh-btn {
            background: #238636;
            color: white;
            margin-bottom: 20px;
        }

        .refresh-btn:hover:not(:disabled) {
            background: #2ea043;
        }

        .refresh-btn:disabled {
            background: #21262d;
            color: #7d8590;
            cursor: not-allowed;
        }

        .networks-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #30363d;
            border-radius: 8px;
            background: #0d1117;
        }

        .network {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #21262d;
            transition: background-color 0.2s ease;
            color: #e6edf3;
        }

        .network:last-child {
            border-bottom: none;
        }

        .network:hover {
            background: #21262d;
        }

        .network.selected {
            background: #1f6feb;
            color: white;
        }

        .no-networks {
            padding: 20px;
            text-align: center;
            color: #7d8590;
            font-style: italic;
        }

        .scanning {
            padding: 20px;
            text-align: center;
            color: #58a6ff;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #21262d;
            border-top: 2px solid #58a6ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #30363d;
            border-radius: 8px;
            font-size: 16px;
            background: #0d1117;
            color: #e6edf3;
            box-sizing: border-box;
            transition: border-color 0.2s ease;
        }

        input[type="text"]:focus, input[type="password"]:focus {
            outline: none;
            border-color: #1f6feb;
            box-shadow: 0 0 0 2px rgba(31, 111, 235, 0.2);
        }

        .save-btn {
            background: #1f6feb;
            color: white;
            margin-top: 8px;
        }

        .save-btn:hover:not(:disabled) {
            background: #388bfd;
        }

        .save-btn:disabled {
            background: #21262d;
            color: #7d8590;
            cursor: not-allowed;
        }

        .help-text {
            font-size: 12px;
            color: #7d8590;
            margin-top: 4px;
        }

        /* Success page styles */
        .success-page {
            display: none;
            text-align: center;
        }

        .success-page.active {
            display: block;
        }

        .success-icon {
            font-size: 48px;
            color: #3fb950;
            margin-bottom: 16px;
        }

        .success-title {
            font-size: 20px;
            font-weight: 600;
            color: #f0f6fc;
            margin-bottom: 16px;
        }

        .credentials-display {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            text-align: left;
        }

        .credential-row {
            display: flex;
            margin-bottom: 8px;
        }

        .credential-row:last-child {
            margin-bottom: 0;
        }

        .credential-label {
            font-weight: 500;
            color: #7d8590;
            width: 80px;
            flex-shrink: 0;
        }

        .credential-value {
            color: #e6edf3;
            word-break: break-all;
        }

        .countdown {
            font-size: 14px;
            color: #7d8590;
            margin-top: 16px;
        }

        .countdown-number {
            font-weight: 600;
            color: #58a6ff;
        }

        /* Hide main form when showing success */
        .container.success .main-form {
            display: none;
        }
    </style>
</head>
<body>
<div class="container" id="container">
    <div class="main-form">
        <!-- Optional logo -->
        <div class="logo" id="logo" style="display: none;">
            <img src="/portalicon.png" alt="Logo" onerror="this.parentElement.style.display='none'">
        </div>

        <h1>CCABN WiFi Setup</h1>

        <div class="form-group">
            <button type="button" class="refresh-btn" id="refreshBtn" onclick="refreshNetworks()">
                Refresh Networks
            </button>
        </div>

        <div class="form-group">
            <label>Available Networks:</label>
            <div class="networks-list" id="networksList">
                {{NETWORKS_LIST}}
            </div>
        </div>

        <form id="wifiForm" onsubmit="saveCredentials(event)">
            <div class="form-group">
                <label for="ssid">Network Name (SSID):</label>
                <input type="text" id="ssid" name="ssid" required>
            </div>

            <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" id="password" name="password">
                <div class="help-text">Leave empty for open networks</div>
            </div>

            <button type="submit" class="save-btn" id="saveBtn">Save</button>
        </form>
    </div>

    <!-- Success page (initially hidden) -->
    <div class="success-page" id="successPage">
        <div class="success-title">Credentials Saved</div>

        <div class="credentials-display" id="credentialsDisplay">
            <div class="credential-row">
                <span class="credential-label">SSID:</span>
                <span class="credential-value" id="savedSsid"></span>
            </div>
            <div class="credential-row">
                <span class="credential-label">Password:</span>
                <span class="credential-value" id="savedPassword"></span>
            </div>
        </div>

        <div class="countdown">
            Page will close in <span class="countdown-number" id="countdownTimer">5</span> seconds
        </div>
    </div>
</div>

<script>
    let countdownInterval = null;

    // Check if the logo image exists and display it if it does
    function checkLogo() {
        const img = new Image();
        img.onload = function() {
            document.getElementById('logo').style.display = 'block';
        };
        img.onerror = function() {
            document.getElementById('logo').style.display = 'none';
        };
        img.src = '/portalicon.png';
    }

    // Handles the manual refresh of WiFi networks
    function refreshNetworks() {
        const refreshBtn = document.getElementById('refreshBtn');
        const networksList = document.getElementById('networksList');

        // Prevent multiple clicks while a scan is in progress
        if (refreshBtn.disabled) {
            return;
        }

        // --- 1. Update button and UI to "Scanning..." state ---
        refreshBtn.disabled = true;
        // The spinner is defined in the CSS block. We add an inline style to make it visible on the button.
        refreshBtn.innerHTML = `<div style="display:flex; align-items:center; justify-content:center; gap:8px;"><div class="spinner" style="border-top-color: white;"></div><span>Scanning...</span></div>`;
        networksList.innerHTML = `<div class='scanning'><div class='spinner'></div>Scanning for networks...</div>`;

        // --- 2. Fetch new network list from the server ---
        // The '?refresh=1' parameter tells the backend to perform a new scan
        fetch('/networks?refresh=1')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.text();
            })
            .then(html => {
                // --- 3. On success, update the list with new data ---
                networksList.innerHTML = html;
                addNetworkClickHandlers();
            })
            .catch(error => {
                // --- 4. On failure, show an error message ---
                console.error('Error refreshing networks:', error);
                networksList.innerHTML = `<div class='no-networks'>Error fetching networks. Please try again.</div>`;
            })
            .finally(() => {
                // --- 5. ALWAYS revert the button to its original state ---
                refreshBtn.disabled = false;
                refreshBtn.textContent = 'Refresh Networks';
            });
    }

    // Adds click handlers to each network in the list to populate the form
    function addNetworkClickHandlers() {
        document.querySelectorAll('.network').forEach(network => {
            network.onclick = function() {
                // Remove previous selection
                document.querySelectorAll('.network').forEach(n => n.classList.remove('selected'));

                // Select clicked network
                this.classList.add('selected');

                // Fill SSID field from the 'data-ssid' attribute
                const ssid = this.dataset.ssid;
                if (ssid) {
                    document.getElementById('ssid').value = ssid;
                    // Focus password field for convenience
                    document.getElementById('password').focus();
                }
            };
        });
    }

    // Handles the submission of the WiFi credentials form
    function saveCredentials(event) {
        event.preventDefault();

        const saveBtn = document.getElementById('saveBtn');
        const originalText = saveBtn.textContent;
        saveBtn.textContent = 'Saving...';
        saveBtn.disabled = true;

        const formData = new FormData(event.target);

        fetch('/connect', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccessPage(data.ssid, data.password);
                } else {
                    alert('Error: ' + (data.error || 'Failed to save credentials'));
                    saveBtn.textContent = originalText;
                    saveBtn.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error saving credentials:', error);
                alert('Error: Failed to save credentials');
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
            });
    }

    // Displays the success page after credentials are saved
    function showSuccessPage(ssid, password) {
        // Update success page with credentials
        document.getElementById('savedSsid').textContent = ssid;
        document.getElementById('savedPassword').textContent = password || '(no password)';

        // Show success page and hide the main form
        document.getElementById('container').classList.add('success');
        document.getElementById('successPage').classList.add('active');

        // Start countdown to close the portal
        let countdown = 5;
        document.getElementById('countdownTimer').textContent = countdown;

        countdownInterval = setInterval(() => {
            countdown--;
            document.getElementById('countdownTimer').textContent = countdown;

            if (countdown <= 0) {
                clearInterval(countdownInterval);
                exitPortal();
            }
        }, 1000);
    }

    // Notifies the backend to exit AP mode
    function exitPortal() {
        fetch('/exit', {
            method: 'POST'
        })
            .then(() => {
                // The portal will close when the device's AP mode is turned off
                document.body.innerHTML = '<div style="text-align:center;padding:50px;color:#e6edf3;">Portal closing... You can now disconnect from this network.</div>';
            })
            .catch(error => {
                console.error('Error exiting portal:', error);
                // Still try to close the window as a fallback
                window.close();
            });
    }

    // --- Initialize page after DOM content is loaded ---
    document.addEventListener('DOMContentLoaded', function() {
        checkLogo();
        addNetworkClickHandlers(); // Add handlers to initially loaded list

        // Auto-refresh networks every 15 seconds for fresh data
        setInterval(function() {
            const refreshBtn = document.getElementById('refreshBtn');
            // Only refresh if a manual scan isn't currently in progress
            if (!refreshBtn.disabled) {
                // Use '/networks' without '?refresh=1' to get cached data from the server
                // without triggering a new, blocking scan.
                fetch('/networks')
                    .then(response => response.text())
                    .then(data => {
                        // Avoids clearing the list if the response is empty
                        if (data && data.trim().length > 0) {
                            document.getElementById('networksList').innerHTML = data;
                            addNetworkClickHandlers();
                        }
                    })
                    .catch(error => {
                        console.error('Error in auto-refresh:', error);
                    });
            }
        }, 15000);
    });
</script>
</body>
</html>
